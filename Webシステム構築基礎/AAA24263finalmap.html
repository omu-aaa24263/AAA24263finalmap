<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>Leaflet 地図（全部入り）</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""
    />

    <!-- Rainviewer CSS -->
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/mwasil/Leaflet.Rainviewer/leaflet.rainviewer.css"
    />

    <!-- Leaflet JS -->
    <script
        src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""
    ></script>

    <!-- Rainviewer JS -->
    <script src="https://cdn.jsdelivr.net/gh/mwasil/Leaflet.Rainviewer/leaflet.rainviewer.js"></script>
</head>

<body>
    <!-- 地図表示領域 -->
    <div id="map" style="height: 80vh;"></div>

    <script>
        /* 背景レイヤー定義 */

        const backgroundLayer = L.tileLayer(
            "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
            {
                maxZoom: 19,
                attribution:
                    '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }
        );

        const chiriinLayer = L.tileLayer(
            "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
            {
                maxZoom: 18,
            }
        );

        /* 地図初期化 */

        const map = L.map("map", {
            center: [34.544865, 135.506274],
            zoom: 15,
            layers: [chiriinLayer], // 初期表示レイヤー
        });

        /* レイヤーコントロール */

        var LayerControl = L.control.layers(
            {
                "地理院地図（標準）": chiriinLayer,
                "OpenStreetMap": backgroundLayer,
            }
        ).addTo(map);

        /* マーカー */

        L.marker([34.544865, 135.506274])
            .bindPopup("なかもずキャンパス C棟")
            .addTo(map);

        /* 学校 */

        fetch("./P29-21_27.geojson")
            .then((response) => response.json())
            .then((data) => {
                const markers = L.geoJSON(data)
                    .bindPopup(
                        (layer) => layer.feature.properties.P29_004
                    )
                    .addTo(map);

                LayerControl.addOverlay(markers, "学校");
            });

        /* ルート */

        fetch("./line.geojson")
            .then((response) => response.json())
            .then((data) => {
                var line = L.geoJSON(data, {
                    color: "#FF00FF",
                    weight: 6,
                    opacity: 0.65,
                });

                map.addLayer(line);
                LayerControl.addOverlay(line, "ルート");
            });

        /* 雨雲レイヤー */

        L.control.rainviewer({
            position: "bottomleft",
            nextButtonText: ">",
            playStopButtonText: "Play/Stop",
            prevButtonText: "<",
            positionSliderLabelText: "Hour:",
            opacitySliderLabelText: "Opacity:",
            animationInterval: 500,
            opacity: 0.5,
        }).addTo(map);

        /* 行政区域 */

        fetch("./N03-23_27_230101.geojson")
            .then((response) => response.json())
            .then((data) => {
                var filteredData = data.features.filter(
                    (feature) =>
                        feature.properties.N03_004 === "堺市中区"
                );

                var selected_area = L.geoJSON(filteredData)
                    .bindPopup(
                        (layer) => layer.feature.properties.N03_004
                    );

                map.addLayer(selected_area);
                LayerControl.addOverlay(selected_area, "行政区域");

                map.fitBounds(selected_area.getBounds());
            });

    // ローカルPC上のOSRMサーバで杉本キャンパスからなかもずキャンパスまでのルートを検索するURL
    const url = 'https://routing.openstreetmap.de/routed-car/route/v1/driving/135.505276,34.592331;135.506274,34.544865?geometries=geojson&overview=full'

    async function addRouteLayer(){
      const response = await fetch(url);
      const json = await response.json();
      routeLayer = L.geoJSON(json['routes'][0]['geometry'],{
                    "color": "#FF00FF",
                    "weight": 6,
                    "opacity": 0.65
                });                            
      routeLayer.addTo(map);
      
      // 地図をルートに合うように調整
      const bounds = routeLayer.getBounds();
      map.fitBounds(bounds); 
      
    }
    // 地図にルートを追加
    addRouteLayer();

        fetch("./27000_2.geojson")
            .then((response) => response.json())
            .then((data) => {
                const markers = L.geoJSON(data)
                    .bindPopup(
                        (layer) => layer.feature.properties.P27000_004
                    )
                    .addTo(map);

                LayerControl.addOverlay(markers, "指定緊急避難所");
            });
    </script>
</body>
</html>